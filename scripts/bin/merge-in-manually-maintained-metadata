#!/usr/bin/env php
<?php

declare(strict_types=1);

use App\IndexEntry;

use function App\isUrl;
use function App\storeTemporaryIndexIntoSQLiteFile;

/**
 * Merges manually maintained metadata into the SQLite file, if not known already.
 */

require 'bootstrap.php';

echo PHP_EOL.'Merge in manually maintained metadata ...';

/*
 * open DB and get a list of all entries
 */
$db = new PDO('sqlite:'.SQLITE_FILE_PATH);
$sql = 'SELECT ontology_uri FROM entry ORDER BY ontology_title ASC';
$stmt = $db->prepare($sql);
$stmt->execute();
$knownontologyIris = $stmt->fetchAll(PDO::FETCH_COLUMN);

/*
 * merge in all manually maintained metadata which is not already part of the SQLite file
 */
$simplifiedOntologyList = [];

// load CSV file and build simplified ontology list
$entries = array_map('str_getcsv', file(__DIR__.'/../../'.MANUALLY_MAINTAINED_METADATA_ABOUT_ONTOLOGIES_CSV));
$unkownIndexEntries = [];
foreach ($entries as $line => $row) {
    if (0 == $line) {
        // ignore header
        continue;
    }
    $ontologyIri = $row[1];

    // check if ontology URI is already known
    $ontologyIsNotInSQLiteFileAlready = false === in_array($ontologyIri, $knownontologyIris);
    if ($ontologyIsNotInSQLiteFileAlready && isUrl($ontologyIri)) {
        $entry = new IndexEntry('Manually maintained', 'https://github.com/k00ni/govi');
        $entry->setOntologyTitle($row[0]);
        $entry->setontologyIri($ontologyIri);

        // related files
        $entry->setLatestN3File($row[2]);
        $entry->setLatestNtFile($row[3]);
        $entry->setLatestRdfXmlFile($row[4]);
        $entry->setLatestTtlFile($row[5]);

        $entry->setLatestAccess($row[6]);

        $unkownIndexEntries[] = $entry;
    } else {
        $msg = 'Ontology '.$row[0].' ('.$ontologyIri.') is known and does not have to be maintained manually!';
        $msg .= ' Please remove it from '.MANUALLY_MAINTAINED_METADATA_ABOUT_ONTOLOGIES_CSV;
        throw new Exception($msg);
    }
}

if (0 < count($unkownIndexEntries)) {
    echo PHP_EOL.'Store '.count($unkownIndexEntries).' unknown entries into SQLite file';
    storeTemporaryIndexIntoSQLiteFile($unkownIndexEntries);
} else {
    throw new Exception('No entries from '.MANUALLY_MAINTAINED_METADATA_ABOUT_ONTOLOGIES_CSV.' to add to SQLite file!');
}

echo PHP_EOL;
echo PHP_EOL;
