#!/usr/bin/env php

<?php

/**
 * Read ontology information from:
 *
 * https://archivo.dbpedia.org/list
 */

require __DIR__.DIRECTORY_SEPARATOR.'..'.DIRECTORY_SEPARATOR.'src'.DIRECTORY_SEPARATOR.'functions.php';

// no time limit for script
\set_time_limit(3600);

/*
 * 1. ask DBpedia archivo to the complete list of ontologies
 */
$url = 'https://archivo.dbpedia.org/list';
$html = file_get_contents($url);

/*
 * 2. build basic index for this provider
 */
$numberOfOntologyEntries = preg_match_all('/<tr>(.*?)<\/tr>/sim', $html, $ontologyEntries);

/*
 * 3. go through each ontology and build index
 */
if (0 < $numberOfOntologyEntries) {
    // this structure contains a temporary index which only holds data about received ontologies
    $temporaryIndex = [];

    echo $numberOfOntologyEntries.' entries'.PHP_EOL;

    // go through received ontologies
    foreach ($ontologyEntries[1] as $ontologyEntryHtml) {
        if (str_contains($ontologyEntryHtml, '<th ')) {
            continue;
        }

        // new entry in temporary index
        $newEntry = [
            'ontology_title' => null,
            'ontology_uri' => null,
            'latest_nt_file' => null,
            'latest_owl_file' => null,
            'latest_ttl_file' => null,
            'source_title' => 'DBpedia Archivo',
            'source_url' => $url,
        ];

        // title/name of ontology
        preg_match('/<td>\s*\n*<a href="\/info\?o=.*?">(.*?)</sim', $ontologyEntryHtml, $title);
        if (isset($title[1]) && false === isEmpty($title[1])) {
            // remove HTML entities like &nbsp;
            $title[1] = html_entity_decode($title[1]);

            $title[1] = preg_replace('/[^0-9a-zA-Z\s\(\)\-\.]/', '', $title[1]);

            // remove trailing whitespaces
            $title[1] = trim($title[1]);

            $newEntry['ontology_title'] = $title[1];
        } else {
            // no title means, no valid meta data, therefore stop
            continue;
        }

        // URI of ontology
        preg_match('/<td>\s*<a href="\/info\?o=(.*?)"/sim', $ontologyEntryHtml, $uri);
        if (isset($uri[1]) && false === isEmpty($uri[1])) {
            $newEntry['ontology_uri'] = $uri[1];
        } else {
            // no URI means, no valid meta data, therefore stop
            continue;
        }

        /*
         * latest OWL/NT,TTL,... file
         */
        $newEntry['latest_owl_file'] = 'http://archivo.dbpedia.org/download?o='.$newEntry['ontology_uri'].'&f=owl';
        $newEntry['latest_nt_file'] = 'http://archivo.dbpedia.org/download?o='.$newEntry['ontology_uri'].'&f=nt';
        $newEntry['latest_ttl_file'] = 'http://archivo.dbpedia.org/download?o='.$newEntry['ontology_uri'].'&f=ttl';

        // store
        $temporaryIndex[$newEntry['ontology_title']] = $newEntry;
    }
} else {
    // nothing found or error
    throw new Exception('No ontology entries found at '.$url);
}

// remove array keys from $temporaryIndex, because they are not needed in CSV
$temporaryIndexWithoutKeys = array_values($temporaryIndex);

/*
 * 4. Merge in entries into index.csv
 */
mergeEntriesIntoIndexCSV($url, $temporaryIndexWithoutKeys);
