#!/usr/bin/env php

<?php

/**
 * Read ontology information from:
 *
 * https://archivo.dbpedia.org/list
 */

use App\IndexEntry;

use function App\cleanTitle;
use function App\isEmpty;
use function App\mergeEntriesIntoIndexCSV;

require __DIR__.DIRECTORY_SEPARATOR.'..'.DIRECTORY_SEPARATOR.'vendor'.DIRECTORY_SEPARATOR.'autoload.php';

// no time limit for script
\set_time_limit(3600);

/*
 * 1. ask DBpedia archivo to the complete list of ontologies
 */
$url = 'https://archivo.dbpedia.org/list';
$html = file_get_contents($url);

/*
 * 2. build basic index for this provider
 */
$numberOfOntologyEntries = preg_match_all('/<tr>(.*?)<\/tr>/sim', $html, $ontologyEntries);

/*
 * 3. go through each ontology and build index
 */
if (0 < $numberOfOntologyEntries) {
    // this structure contains a temporary index which only holds data about received ontologies
    $temporaryIndex = [];

    // go through received ontologies
    foreach ($ontologyEntries[1] as $ontologyEntryHtml) {
        if (str_contains($ontologyEntryHtml, '<th ')) {
            continue;
        }

        // new entry in temporary index
        $newEntry = new IndexEntry('DBpedia Archivo', $url);

        // title/name of ontology
        preg_match('/<td>\s*\n*<a href="\/info\?o=.*?">(.*?)</sim', $ontologyEntryHtml, $title);
        if (isset($title[1]) && false === isEmpty($title[1])) {
            $newEntry->setOntologyTitle(cleanTitle($title[1]));
        } else {
            // no title means, no valid meta data, therefore stop
            continue;
        }

        // URI of ontology
        preg_match('/<td>\s*<a href="\/info\?o=(.*?)"/sim', $ontologyEntryHtml, $uri);
        if (isset($uri[1]) && false === isEmpty($uri[1])) {
            $newEntry->setOntologyUri($uri[1]);
        } else {
            // no URI means, no valid meta data, therefore stop
            continue;
        }

        /*
         * latest OWL,TTL,... file
         */
        $newEntry->setLatestNtFile('http://archivo.dbpedia.org/download?o='.$newEntry->getOntologyUri().'&f=nt');
        $newEntry->setLatestRdfXmlFile('http://archivo.dbpedia.org/download?o='.$newEntry->getOntologyUri().'&f=owl');
        $newEntry->setLatestTtlFile('http://archivo.dbpedia.org/download?o='.$newEntry->getOntologyUri().'&f=ttl');

        // store (use title as key to avoid doublings)
        $temporaryIndex[$newEntry->getOntologyTitle()] = $newEntry;
    }
} else {
    // nothing found or error
    throw new Exception('No ontology entries found at '.$url);
}

// remove array keys from $temporaryIndex, because they are not needed in CSV
$temporaryIndexWithoutKeys = array_values($temporaryIndex);

/*
 * 4. Merge in entries into index.csv
 */
mergeEntriesIntoIndexCSV($url, $temporaryIndexWithoutKeys);

echo $url.' => '. $numberOfOntologyEntries.' entries'.PHP_EOL;
